<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <title>Chat Window</title>

    <style>
        .chat-container {
            height: 500px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 10px;
        }

        .message {
            margin-bottom: 10px;
        }

        .incoming {
            text-align: left;
        }

        .outgoing {
            text-align: right;
        }

        .typing-indicator {
            width: 100%;
            height: 30px;
            /* Adjust as necessary */
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .typing-indicator.active {
            opacity: 1;
        }

        .message .alert {
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="chat-container">
            {% for message in messages %}
            {% if message.role == 'user' %}
            <div class="message outgoing">
                <div class="alert alert-primary" role="alert">
                    {{ message.content }}
                </div>
            </div>
            {% elif message.role == 'assistant' %}
            <div class="message incoming">
                <div class="alert alert-secondary" role="alert">
                    {{ message.content }}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div id="typing" class="typing-indicator">
            <p>Assistant is typing...</p>
        </div>


        <form id="chat-form">
            <div class="form-group">
                <textarea class="form-control" id="message-input" name="message"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>

        <button id="clear-chat" class="btn btn-secondary">Clear Chat</button>
    </div>

    <script>
        $(document).ready(function () {
            $('#chat-form').on('submit', function (e) {
                e.preventDefault();

                var userMessageContent = $('#message-input').val();

                // Immediately add user's message to chat window
                var userMessageElement = $('<div class="message outgoing"><div class="alert alert-primary" role="alert"></div></div>');
                userMessageElement.find('.alert').text(userMessageContent);
                $('.chat-container').append(userMessageElement);

                // Scroll to the bottom of the chat window
                $('.chat-container').scrollTop($('.chat-container')[0].scrollHeight);

                // Show typing animation
                $('#typing').addClass('active');

                $.ajax({
                    url: '/send',
                    type: 'POST',
                    data: {
                        message: userMessageContent
                    },
                    success: function (data) {
                        // Hide typing animation
                        $('#typing').removeClass('active');

                        // Add assistant's message to chat window
                        var assistantMessageElement = $('<div class="message incoming"><div class="alert alert-secondary" role="alert"></div></div>');
                        assistantMessageElement.find('.alert').text(data.message.content);
                        $('.chat-container').append(assistantMessageElement);

                        // Scroll to the bottom of the chat window
                        $('.chat-container').scrollTop($('.chat-container')[0].scrollHeight);
                    }
                });


                // Clear input field
                $('#message-input').val('');
            });
        });

        // Add an event listener to the clear chat button
        $('#clear-chat').on('click', function () {
            // Send a POST request to the /clear route
            $.ajax({
                url: '/clear',
                type: 'POST',
                success: function (data) {
                    // Remove all messages from the chat window
                    $('.chat-container').empty();
                    
                    // Alternatively, if you want to refresh the entire page you can use:
                    // location.reload();
                }
            });
        });
    </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>